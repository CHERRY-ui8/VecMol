# Diffusion 训练调试日志实施总结

## 已添加的调试日志位置

### 1. `train_fm_lt.py` - 训练入口

#### 位置1: `_training_step_ddpm()` 函数入口 (line ~207)
- **记录内容**: 输入 `codes` 的统计信息
- **假设**: A (输入数据数值范围异常)
- **频率**: 每个batch

#### 位置2: `_training_step_ddpm()` 调用 `train_ddpm_step` 前 (line ~240)
- **记录内容**: 
  - `codes` 的统计信息
  - `diffusion_method`
  - `num_timesteps`
- **假设**: A (输入数据数值范围异常)
- **频率**: 每个batch

#### 位置2b: `_training_step_ddpm()` 损失计算后 (line ~256)
- **记录内容**: 
  - `loss` 值
  - `loss` 是否包含 NaN/Inf
- **假设**: E (损失计算数值不稳定)
- **频率**: 每个batch

### 2. `ddpm.py` - DDPM核心逻辑

#### 位置3: `compute_ddpm_loss_x0()` 函数入口 (line ~398)
- **记录内容**: 
  - `x_0` 的统计信息
  - `use_time_weight` 标志
- **假设**: A (输入数据数值范围异常)
- **频率**: 每次调用

#### 位置4: 时间步采样后 (line ~417)
- **记录内容**: 
  - `t` 的最小值、最大值、均值、标准差
  - `t` 的前10个值
- **假设**: B (时间步采样分布不均匀)
- **频率**: 每次调用

#### 位置5: 噪声生成后 (line ~420)
- **记录内容**: `noise` 的统计信息
- **假设**: C (前向扩散过程计算错误)
- **频率**: 每次调用

#### 位置6: 前向扩散后 (line ~423)
- **记录内容**: 
  - `x_t` 的统计信息
  - `x_0` 和 `noise` 的统计信息（用于验证）
- **假设**: C (前向扩散过程计算错误)
- **频率**: 每次调用

#### 位置7: 模型预测后 (line ~426)
- **记录内容**: 
  - `predicted_x0` 的统计信息
  - `x_0` 的统计信息（目标值）
- **假设**: D (模型预测输出异常)
- **频率**: 每次调用

#### 位置8: 损失计算后 (line ~430-440)
- **记录内容**: 
  - `loss` 值
  - `loss_per_sample` 的统计信息
  - `weights` 的统计信息（如果使用时间权重）
  - 是否包含 NaN/Inf
- **假设**: E (损失计算数值不稳定)
- **频率**: 每次调用

#### 位置9: `q_sample()` 函数内部 (line ~98-121)
- **记录内容**: 
  - `sqrt_alphas_cumprod_t` 的统计信息
  - `sqrt_one_minus_alphas_cumprod_t` 的统计信息
- **假设**: C (前向扩散过程计算错误)
- **频率**: 每10次调用记录一次（避免日志过多）

### 3. `funcmol.py` - 模型前向传播

#### 位置10: `forward()` 函数入口 (line ~95)
- **记录内容**: 
  - 输入 `y` 的统计信息
  - 时间步 `t` 的统计信息
  - `diffusion_method`
- **假设**: D (模型预测输出异常)
- **频率**: 每10次调用记录一次

#### 位置11: `forward()` 函数输出 (line ~115)
- **记录内容**: `xhat` 的统计信息
- **假设**: D (模型预测输出异常)
- **频率**: 每10次调用记录一次

#### 位置12: 扩散常数初始化 (line ~66)
- **记录内容**: 
  - `betas` 的前10个和后10个值
  - `alphas_cumprod` 的前10个和后10个值
  - `sqrt_alphas_cumprod` 的前10个和后10个值
  - `sqrt_one_minus_alphas_cumprod` 的前10个和后10个值
- **假设**: F (扩散常数计算错误)
- **频率**: 只在模型初始化时记录一次

## 日志文件位置

所有日志都写入到：
```
/datapool/data2/home/pxg/data/hyc/funcmol-main-neuralfield/.cursor/debug.log
```

## 日志格式

日志采用 NDJSON 格式（每行一个 JSON 对象），包含以下字段：
- `id`: 唯一标识符
- `timestamp`: 时间戳（毫秒）
- `location`: 代码位置（文件:行号）
- `message`: 日志消息
- `data`: 记录的数据（字典）
- `sessionId`: 会话ID（固定为 "debug-session"）
- `runId`: 运行ID（默认为 "run1"）
- `hypothesisId`: 关联的假设ID（A-F，可选）

## 辅助函数

### `debug_log()`
用于记录调试日志的辅助函数，定义在：
- `train_fm_lt.py`
- `ddpm.py`
- `funcmol.py`

### `get_tensor_stats()`
用于获取张量统计信息的辅助函数，返回包含以下信息的字典：
- `{name}_shape`: 形状
- `{name}_dtype`: 数据类型
- `{name}_device`: 设备
- `{name}_min`: 最小值
- `{name}_max`: 最大值
- `{name}_mean`: 均值
- `{name}_std`: 标准差
- `{name}_has_nan`: 是否包含 NaN
- `{name}_has_inf`: 是否包含 Inf

## 使用说明

1. **运行训练前**: 清空日志文件（使用 `delete_file` 工具）
2. **运行训练**: 正常执行训练脚本
3. **分析日志**: 读取日志文件，分析每个假设的验证情况
4. **修复问题**: 根据日志证据修复问题
5. **验证修复**: 再次运行并对比修复前后的日志
6. **清理日志**: 确认修复成功后，移除调试日志代码

## 假设验证指南

### 假设A: 输入数据数值范围异常
- **检查位置**: 位置1, 2, 3
- **关键指标**: `codes_min`, `codes_max`, `codes_mean`, `codes_std`
- **正常范围**: 归一化后的 codes 通常在 [-3, 3] 范围内

### 假设B: 时间步采样分布不均匀
- **检查位置**: 位置4
- **关键指标**: `t_min`, `t_max`, `t_mean`, `t_std`
- **正常情况**: `t` 应该在 [0, num_timesteps-1] 范围内均匀分布

### 假设C: 前向扩散过程计算错误
- **检查位置**: 位置5, 6, 9
- **关键指标**: `x_t` 的统计信息，扩散常数的值
- **验证**: `x_t` 应该介于 `x_0` 和 `noise` 之间

### 假设D: 模型预测输出异常
- **检查位置**: 位置7, 10, 11
- **关键指标**: `predicted_x0` 的统计信息，是否包含 NaN/Inf
- **正常情况**: 不应包含 NaN/Inf，数值范围合理

### 假设E: 损失计算数值不稳定
- **检查位置**: 位置2b, 8
- **关键指标**: `loss` 值，是否包含 NaN/Inf
- **正常情况**: 损失值应为正数，不包含 NaN/Inf

### 假设F: 扩散常数计算错误
- **检查位置**: 位置12
- **关键指标**: `betas`, `alphas_cumprod` 等常数的值
- **验证**: 检查常数是否符合预期（例如，betas 应该单调递增）

## 注意事项

1. 日志记录使用 `#region agent log` 和 `#endregion` 包裹，可以在编辑器中折叠
2. 日志记录失败不会影响训练（使用 try-except 静默处理）
3. 某些位置使用采样记录（每10次调用记录一次）以避免日志过多
4. 所有日志都包含时间戳，可以用于分析训练过程中的变化
